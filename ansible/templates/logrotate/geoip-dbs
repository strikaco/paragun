# Downloads the newest version of the Maxmind GeoLite2 databases weekly.

# The GeoIP2 and GeoIP Legacy Country and City databases are updated every 
# Tuesday. The GeoIP2 ISP, GeoIP Legacy ISP and Organization databases are 
# updated every one to two weeks. All other databases are updated on the first 
# Tuesday of each month.

# TODO: Make the gateway precache downloads of the databases, then have each node
# retrieve new databases from the gateway instead of hammering Maxmind.

/usr/share/GeoIP/*.mmdb
{
        weekly
        sharedscripts
        extension .mmdb
        nocompress
        
        rotate 2
        nomissingok
        ifempty
        
        dateext
        dateformat .%Y-%m-%d
        
        prerotate
                /bin/sh /usr/local/bin/update_geoip.sh
        endscript
        
        # On rotate: Y-m-d get appended to mmdb
        
        postrotate
                # Update symlink to point to latest db for each type
                ln -sf /usr/share/GeoIP/GeoLite2-City.$(date +"%Y-%m-%d").mmdb /usr/share/GeoIP/latest-city
                ln -sf /usr/share/GeoIP/GeoLite2-ASN.$(date +"%Y-%m-%d").mmdb /usr/share/GeoIP/latest-asn
        
                # Reload rsyslog (SIGHUP)
                /usr/sbin/invoke-rc.d rsyslog rotate > /dev/null
        endscript
        
        lastaction
                # Clean up temp files
                rm /tmp/GeoLite2-*.tar.gz
                rm /tmp/GeoLite2-*.mmdb
        endscript
}